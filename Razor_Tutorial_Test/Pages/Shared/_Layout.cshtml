<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Razor_Tutorial_Test</title>
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
    <script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css" />
    <link href="https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">

    <!-- Cropper.js CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">

</head>
<body>
    @inject Razor_Tutorial_Test.Data.ApplicationDbContext _context

    @{
        var userId = Context.Session.GetInt32("UserID");
        int unreadCount = 0;

        if (userId != null)
        {
            unreadCount = _context.Notifications
            .Where(n => n.UserId == userId && n.IsRead == false)
            .Count();
        }
    }
    <header>
        <nav class="navbar navbar-expand-lg bg-secondary text-uppercase fixed-top" id="mainNav">
            <div class="container">
                <a class="navbar-brand" asp-page="/Index">Second Life</a>

                <div class="d-flex align-items-center">
                    @if (userId != null)
                    {
                        <div id="notificationWrapper">
                            <!-- Notification Icon -->
                            <a class="nav-link position-relative text-white me-4" id="notificationLink" asp-page="/NotificationAlert/Index" title="Notifications">
                                <i class="fas fa-bell fa-xl"></i>
                                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
                                      id="unreadCount"
                                      style="@(unreadCount > 0 ? "" : "display:none;")">
                                    @unreadCount
                                </span>
                            </a>
                        </div>
                    }
                    <!-- User Profile Icon -->
                    @if (userId != null)
                    {
                        <a class="nav-link text-white" asp-page="/UserProfile/Index" title="Profile">
                            <i class="fas fa-user-circle fa-xl"></i>
                        </a>
                    }
                    else
                    {
                        <a class="nav-link text-white" asp-page="/Session/Login" title="Login">
                            <i class="fas fa-user-circle fa-xl"></i>
                        </a>
                    }
                </div>
            </div>
        </nav>
    </header>
        <main role="main">
            <partial name="_ValidationScriptsPartial.cshtml" />
            @RenderBody()
        </main>

    <div class="copyright py-4 text-center text-white bg-secondary">
        <div class="container"><small>Copyright &copy; Second Life 2025</small></div>
    </div>
    <!-- Bootstrap core JS-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>
    <!-- Cropper.js JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <!-- SignalR Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Only set up SignalR if user is logged in (userId exists)
            const unreadCountElement = document.getElementById("unreadCount");

            if (unreadCountElement) {
                const notificationConnection = new signalR.HubConnectionBuilder()
                    .withUrl("/notificationhub")
                    .withAutomaticReconnect()
                    .build();

                notificationConnection.start().then(function () {
                    console.log("Connected to NotificationHub");
                }).catch(function(err) {
                    console.error("SignalR Connection Error: ", err);
                });

                // Listen for real-time unread count updates
                notificationConnection.on("UpdateUnreadCount", function (newUnreadCount) {
                    console.log("Received updated unread count:", newUnreadCount);

                    if (newUnreadCount > 0) {
                        unreadCountElement.textContent = newUnreadCount;
                        unreadCountElement.style.display = "";
                    } else {
                        unreadCountElement.style.display = "none";
                    }
                });

                // Handle connection closed/errors
                notificationConnection.onclose(function() {
                    console.log("SignalR connection closed");
                    setTimeout(function() {
                        notificationConnection.start();
                    }, 5000); // Try to reconnect after 5 seconds
                });
            }
        });
    </script>
    @await RenderSectionAsync("Scripts", required: false) 
</body>
</html>
